<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitchenPro - Dapur Racik Dinda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCaloFOXMSvi69fW3kNJ_R50dQoZYMIchY",
            authDomain: "drdkitchen-db.firebaseapp.com",
            projectId: "drdkitchen-db",
            storageBucket: "drdkitchen-db.firebasestorage.app",
            messagingSenderId: "468299951343",
            appId: "1:468299951343:web:81b886f1c04325ce59ff1a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fb = { collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch, query, orderBy, getDocs };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n);
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : "-";

        // --- COMPONENTS ---
        const Icon = ({ name, size = 20 }) => {
            const ref = React.useRef(null);
            React.useEffect(() => { if (ref.current && window.lucide) window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: `lucide lucide-${name}` } }); }, [name, size]);
            return <span ref={ref} className="inline-flex"><i data-lucide={name}></i></span>;
        };
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-6 ${className}`}>{children}</div>;
        const Button = ({ onClick, children, variant = "primary", className = "" }) => {
            const base = "px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-all";
            const v = { primary: "bg-emerald-600 text-white hover:bg-emerald-700", secondary: "bg-white border hover:bg-slate-50", danger: "bg-rose-50 text-rose-600 hover:bg-rose-100" };
            return <button onClick={onClick} className={`${base} ${v[variant]} ${className}`}>{children}</button>;
        };
        const Badge = ({ children, type = "default" }) => <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${type === 'danger' ? 'bg-rose-100 text-rose-700' : type === 'success' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-700'}`}>{children}</span>;

        // --- SUB-VIEWS (Restored Features) ---

        const FinanceView = ({ logs, requests }) => {
            const [startDate, setStartDate] = useState(new Date().toISOString().slice(0, 10));
            const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
            const [opsCost, setOpsCost] = useState(0);

            const stats = useMemo(() => {
                const filtered = logs.filter(l => l.date >= startDate && l.date <= endDate + "T23:59");
                let rev = 0, cogs = 0, waste = 0;
                filtered.forEach(l => {
                    if (l.revenue) { rev += l.revenue; cogs += l.cost; } 
                    else { waste += l.cost; }
                });
                return { rev, cogs, waste, net: rev - cogs - waste - opsCost };
            }, [logs, startDate, endDate, opsCost]);

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">Laporan Keuangan</h3>
                            <div className="flex gap-2">
                                <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="border p-2 rounded" />
                                <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="border p-2 rounded" />
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div className="p-4 bg-emerald-50 rounded-xl"><div className="text-sm text-emerald-800">Pendapatan</div><div className="text-2xl font-bold text-emerald-600">{formatRupiah(stats.rev)}</div></div>
                            <div className="p-4 bg-blue-50 rounded-xl"><div className="text-sm text-blue-800">HPP (Modal)</div><div className="text-2xl font-bold text-blue-600">{formatRupiah(stats.cogs)}</div></div>
                            <div className="p-4 bg-rose-50 rounded-xl"><div className="text-sm text-rose-800">Waste (Terbuang)</div><div className="text-2xl font-bold text-rose-600">{formatRupiah(stats.waste)}</div></div>
                            <div className="p-4 bg-indigo-50 rounded-xl"><div className="text-sm text-indigo-800">Laba Bersih</div><div className="text-2xl font-bold text-indigo-600">{formatRupiah(stats.net)}</div></div>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="font-bold">Biaya Operasional Lain:</span>
                            <input type="number" value={opsCost} onChange={e=>setOpsCost(Number(e.target.value))} className="border p-2 rounded w-40" placeholder="Listrik, Gaji, dll" />
                        </div>
                    </Card>
                </div>
            );
        };

        const RestockView = ({ inventory, requests, user }) => {
            const [cart, setCart] = useState({});
            
            const handleOrder = async () => {
                const items = inventory.filter(i => cart[i.id] > 0).map(i => ({
                    id: i.id, name: i.name, qty: parseFloat(cart[i.id]), price: i.price, unit: i.unit, isRealized: false
                }));
                if(items.length === 0) return alert("Pilih item dulu!");
                
                try {
                    await window.fb.addDoc(window.fb.collection(window.db, "requests"), {
                        date: new Date().toISOString(), requester: user.name, items, status: 'pending',
                        totalEst: items.reduce((a,b)=>a+(b.qty*b.price),0)
                    });
                    setCart({}); alert("Request terkirim!");
                } catch(e) { alert(e.message); }
            };

            const toggleRealize = async (req, itemIndex) => {
                if(user.role !== 'ceo') return alert("Hanya CEO yg bisa validasi");
                const newItems = [...req.items];
                const item = newItems[itemIndex];
                if(item.isRealized) return; // Already done

                if(!confirm(`Validasi barang masuk: ${item.name} (${item.qty})? Stok akan bertambah.`)) return;

                const db = window.db;
                const batch = window.fb.writeBatch(db);
                
                // 1. Update Request status locally to batch
                item.isRealized = true;
                const allDone = newItems.every(i => i.isRealized);
                batch.update(window.fb.doc(db, "requests", req.id), { items: newItems, status: allDone ? 'done' : 'pending' });

                // 2. Update Inventory Stock
                const invItem = inventory.find(i => i.id === item.id);
                if(invItem) {
                    batch.update(window.fb.doc(db, "inventory", item.id), { stock: Number(invItem.stock) + Number(item.qty) });
                }

                await batch.commit();
            };

            return (
                <div className="space-y-6">
                    <Card>
                        <h3 className="font-bold text-lg mb-4">Buat Request Stok Baru</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                            {inventory.map(item => (
                                <div key={item.id} className={`p-3 border rounded-lg ${item.stock <= item.minStock ? 'bg-rose-50 border-rose-200' : 'bg-white'}`}>
                                    <div className="flex justify-between font-bold text-sm"><span>{item.name}</span> <span className={item.stock<=item.minStock?'text-rose-600':''}>{item.stock}</span></div>
                                    <div className="flex items-center gap-2 mt-2">
                                        <input type="number" placeholder="Jml Beli" className="w-full border p-1 rounded" 
                                            value={cart[item.id] || ''} onChange={e=>setCart({...cart, [item.id]: e.target.value})} />
                                        <span className="text-xs text-gray-500">{item.unit}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-4 pt-4 border-t">
                            <Button onClick={handleOrder}><Icon name="send"/> Kirim Request</Button>
                        </div>
                    </Card>

                    <div className="space-y-4">
                        <h3 className="font-bold text-lg">Daftar Request</h3>
                        {requests.sort((a,b)=>b.date.localeCompare(a.date)).map(req => (
                            <Card key={req.id} className={req.status==='done'?'opacity-70 bg-gray-50':''}>
                                <div className="flex justify-between items-start mb-2">
                                    <div><div className="font-bold">{formatDate(req.date)}</div><div className="text-xs text-gray-500">by {req.requester}</div></div>
                                    <Badge type={req.status==='done'?'success':'warning'}>{req.status}</Badge>
                                </div>
                                <div className="space-y-1">
                                    {req.items.map((item, idx) => (
                                        <div key={idx} className="flex justify-between text-sm p-1 border-b border-dashed">
                                            <div className="flex items-center gap-2">
                                                <button onClick={()=>toggleRealize(req, idx)} disabled={item.isRealized} className={`w-4 h-4 rounded border ${item.isRealized?'bg-emerald-500 border-emerald-500':'bg-white'}`}></button>
                                                <span className={item.isRealized?'line-through text-gray-400':''}>{item.name}</span>
                                            </div>
                                            <div>{item.qty} {item.unit}</div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        ))}
                    </div>
                </div>
            );
        };

        const HPPCalculator = ({ inventory }) => {
            const [rows, setRows] = useState([{id:1, itemId:'', qty:0}]);
            const [overhead, setOverhead] = useState(0);
            const [margin, setMargin] = useState(30);

            const totalBase = rows.reduce((sum, r) => {
                const item = inventory.find(i=>i.id===r.itemId);
                return sum + (item ? item.price * r.qty : 0);
            }, 0) + Number(overhead);
            
            const sellingPrice = totalBase / (1 - (margin/100));

            return (
                <Card>
                    <h3 className="font-bold text-lg mb-4">Kalkulator HPP & Harga Jual</h3>
                    <div className="space-y-2 mb-4">
                        {rows.map((r, i) => (
                            <div key={r.id} className="flex gap-2">
                                <select className="flex-1 border p-2 rounded" value={r.itemId} onChange={e=>{const n=[...rows];n[i].itemId=e.target.value;setRows(n)}}>
                                    <option value="">- Pilih Bahan -</option>
                                    {inventory.map(item=><option key={item.id} value={item.id}>{item.name} (@{item.price})</option>)}
                                </select>
                                <input type="number" className="w-20 border p-2 rounded" placeholder="Qty" value={r.qty} onChange={e=>{const n=[...rows];n[i].qty=e.target.value;setRows(n)}} />
                                <button onClick={()=>setRows(rows.filter((_,x)=>x!==i))} className="text-rose-500"><Icon name="x"/></button>
                            </div>
                        ))}
                        <Button variant="secondary" onClick={()=>setRows([...rows, {id:Date.now(), itemId:'', qty:0}])}><Icon name="plus"/> Bahan</Button>
                    </div>
                    <div className="grid grid-cols-2 gap-4 border-t pt-4">
                        <div>
                            <label className="text-xs font-bold block">Biaya Lain (Packaging/Gas)</label>
                            <input type="number" className="border p-2 rounded w-full" value={overhead} onChange={e=>setOverhead(e.target.value)} />
                        </div>
                        <div>
                            <label className="text-xs font-bold block">Target Margin (%)</label>
                            <input type="number" className="border p-2 rounded w-full" value={margin} onChange={e=>setMargin(e.target.value)} />
                        </div>
                    </div>
                    <div className="mt-6 bg-slate-50 p-4 rounded-xl text-center">
                        <div className="text-sm text-gray-500">Saran Harga Jual</div>
                        <div className="text-3xl font-bold text-emerald-600">{formatRupiah(sellingPrice)}</div>
                        <div className="text-xs text-gray-400">Modal: {formatRupiah(totalBase)} | Profit: {formatRupiah(sellingPrice - totalBase)}</div>
                    </div>
                </Card>
            );
        };

        // --- MAIN APP ---
        function KitchenPro() {
            const [view, setView] = useState('dashboard');
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('fnb_user_role')) || null);
            const [inventory, setInventory] = useState([]);
            const [products, setProducts] = useState([]);
            const [logs, setLogs] = useState([]);
            const [requests, setRequests] = useState([]);

            useEffect(() => {
                if (!window.fb || !window.db) return;
                const db = window.db;
                const unsubInv = window.fb.onSnapshot(window.fb.collection(db, "inventory"), s => setInventory(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubProd = window.fb.onSnapshot(window.fb.collection(db, "products"), s => setProducts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubLogs = window.fb.onSnapshot(window.fb.query(window.fb.collection(db, "usageLog"), window.fb.orderBy("date", "desc")), s => setLogs(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubReq = window.fb.onSnapshot(window.fb.collection(db, "requests"), s => setRequests(s.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => { unsubInv(); unsubProd(); unsubLogs(); unsubReq(); };
            }, []);

            const handleLogin = (role) => { const u={role, name:role==='owner'?'Owner':'CEO'}; setUser(u); localStorage.setItem('fnb_user_role', JSON.stringify(u)); };
            
            if(!user) return (
                <div className="h-screen flex items-center justify-center bg-slate-900">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm text-center">
                        <h1 className="text-2xl font-bold mb-6">KitchenPro Login</h1>
                        <button onClick={()=>handleLogin('owner')} className="w-full bg-emerald-600 text-white p-3 rounded-lg font-bold mb-3">Owner (Akses Penuh)</button>
                        <button onClick={()=>handleLogin('ceo')} className="w-full border p-3 rounded-lg font-bold">Staff / CEO</button>
                    </div>
                </div>
            );

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-grid', role: 'all' },
                { id: 'list', label: 'Stok Bahan', icon: 'package', role: 'all' },
                { id: 'products', label: 'Menu Resep', icon: 'coffee', role: 'all' },
                { id: 'usage', label: 'Catat Pakai', icon: 'clipboard-minus', role: 'all' },
                { id: 'restock', label: 'Restock', icon: 'shopping-cart', role: 'all' },
                { id: 'hpp', label: 'Kalkulator', icon: 'calculator', role: 'all' },
                { id: 'finance', label: 'Keuangan', icon: 'banknote', role: 'owner' },
            ];

            return (
                <div className="flex h-screen bg-slate-50">
                    <div className="w-64 bg-slate-900 text-white flex flex-col hidden md:flex">
                        <div className="p-6 font-bold text-xl border-b border-slate-800 flex gap-2 items-center"><Icon name="chef-hat"/> KitchenPro</div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            {menuItems.filter(m=>m.role==='all'||m.role===user.role).map(m => (
                                <button key={m.id} onClick={()=>setView(m.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${view===m.id?'bg-emerald-600 text-white':'text-slate-400 hover:bg-slate-800'}`}>
                                    <Icon name={m.icon}/> {m.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-800"><button onClick={()=>{setUser(null); localStorage.removeItem('fnb_user_role');}} className="flex gap-2 text-rose-400"><Icon name="log-out"/> Logout</button></div>
                    </div>
                    
                    <main className="flex-1 overflow-auto">
                        <div className="md:hidden p-4 bg-white border-b flex justify-between">
                            <span className="font-bold">KitchenPro</span>
                            <div className="flex gap-2">
                                <button onClick={()=>setView('dashboard')} className="p-2 bg-gray-100 rounded"><Icon name="layout-grid"/></button>
                                <button onClick={()=>setView('usage')} className="p-2 bg-gray-100 rounded"><Icon name="clipboard-minus"/></button>
                            </div>
                        </div>

                        <div className="p-6 max-w-7xl mx-auto">
                            {/* DASHBOARD */}
                            {view === 'dashboard' && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <Card className="bg-emerald-50"><div className="text-sm text-emerald-800">Total Aset</div><div className="text-2xl font-bold text-emerald-600">{formatRupiah(inventory.reduce((a,b)=>a+(b.stock*b.price),0))}</div></Card>
                                    <Card className="bg-blue-50"><div className="text-sm text-blue-800">Menu Aktif</div><div className="text-2xl font-bold text-blue-600">{products.length} Menu</div></Card>
                                    <Card className="bg-rose-50"><div className="text-sm text-rose-800">Perlu Restock</div><div className="text-2xl font-bold text-rose-600">{inventory.filter(i=>i.stock<=i.minStock).length} Item</div></Card>
                                </div>
                            )}

                            {/* STOK BAHAN */}
                            {view === 'list' && (
                                <Card>
                                    <div className="flex justify-between mb-4"><h2 className="text-xl font-bold">Stok Bahan Baku</h2>{user.role==='owner'&&<Button onClick={()=>{const n=prompt("Nama Bahan:");if(n)window.fb.addDoc(window.fb.collection(window.db,"inventory"),{name:n,stock:0,unit:'kg',price:0,minStock:5,category:'Umum'})}}><Icon name="plus"/> Baru</Button>}</div>
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-50"><tr><th className="p-3">Nama</th><th className="p-3">Stok</th><th className="p-3">Aksi</th></tr></thead>
                                        <tbody>
                                            {inventory.map(i=>(
                                                <tr key={i.id} className="border-b">
                                                    <td className="p-3 font-medium">{i.name} <div className="text-xs text-gray-400">{formatRupiah(i.price)}/{i.unit}</div></td>
                                                    <td className="p-3"><span className={i.stock<=i.minStock?'text-rose-600 font-bold':''}>{i.stock} {i.unit}</span></td>
                                                    <td className="p-3 flex gap-2">
                                                        <button onClick={()=>{const s=prompt("Update Stok (+/-):",0);if(s)window.fb.updateDoc(window.fb.doc(window.db,"inventory",i.id),{stock:Number(i.stock)+Number(s)})}} className="text-blue-600 bg-blue-50 p-1 rounded"><Icon name="edit-2" size={16}/></button>
                                                        {user.role==='owner'&&<button onClick={()=>confirm("Hapus?")&&window.fb.deleteDoc(window.fb.doc(window.db,"inventory",i.id))} className="text-rose-600 bg-rose-50 p-1 rounded"><Icon name="trash-2" size={16}/></button>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </Card>
                            )}
                            
                            {/* MENU RESEP (SIMPLIFIED) */}
                            {view === 'products' && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {products.map(p=>(
                                        <Card key={p.id}>
                                            <div className="font-bold text-lg">{p.name}</div>
                                            <div className="text-emerald-600 font-bold">{formatRupiah(p.sellingPrice)}</div>
                                            <div className="mt-4 flex gap-2"><button onClick={()=>{if(confirm(`Produksi 1 ${p.name}?`)){
                                                const batch=window.fb.writeBatch(window.db);
                                                p.recipe.forEach(r=>{const i=inventory.find(x=>x.id===r.itemId);if(i)batch.update(window.fb.doc(window.db,"inventory",r.itemId),{stock:i.stock-r.qty})});
                                                window.fb.addDoc(window.fb.collection(window.db,"usageLog"),{date:new Date().toISOString(),itemName:`[Produksi] ${p.name}`,amount:1,unit:'porsi',reason:'Produksi',cost:0,revenue:p.sellingPrice});
                                                batch.commit().then(()=>alert("Sukses!"));
                                            }}} className="w-full bg-emerald-600 text-white py-2 rounded">Produksi 1 Porsi</button></div>
                                        </Card>
                                    ))}
                                    {user.role==='owner'&&<button onClick={()=>{const n=prompt("Nama Menu:");if(n)window.fb.addDoc(window.fb.collection(window.db,"products"),{name:n,sellingPrice:0,recipe:[],overhead:0})}} className="border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center font-bold text-gray-400 p-6">+ Menu Baru</button>}
                                </div>
                            )}

                            {/* CATAT PAKAI */}
                            {view === 'usage' && (
                                <div className="grid md:grid-cols-2 gap-6">
                                    <Card>
                                        <h3 className="font-bold mb-4">Catat Manual</h3>
                                        <form onSubmit={e=>{e.preventDefault();const fd=new FormData(e.target);const i=inventory.find(x=>x.id===fd.get('itemId'));if(!i)return;const q=Number(fd.get('qty'));window.fb.updateDoc(window.fb.doc(window.db,"inventory",i.id),{stock:i.stock-q});window.fb.addDoc(window.fb.collection(window.db,"usageLog"),{date:new Date().toISOString(),itemName:i.name,amount:q,unit:i.unit,reason:fd.get('reason'),cost:q*i.price});e.target.reset();alert("Tercatat!")}} className="space-y-4">
                                            <select name="itemId" className="w-full border p-2 rounded" required><option value="">Pilih Item</option>{inventory.map(i=><option key={i.id} value={i.id}>{i.name}</option>)}</select>
                                            <input name="qty" type="number" placeholder="Jumlah" className="w-full border p-2 rounded" required />
                                            <select name="reason" className="w-full border p-2 rounded"><option>Rusak/Basi</option><option>Tumpah</option><option>Tester</option></select>
                                            <Button type="submit" className="w-full justify-center">Simpan</Button>
                                        </form>
                                    </Card>
                                    <Card>
                                        <h3 className="font-bold mb-4">Log Terakhir</h3>
                                        {logs.slice(0,5).map(l=><div key={l.id} className="border-b p-2 text-sm flex justify-between"><span>{l.itemName}</span><span className="font-bold text-rose-500">-{l.amount}</span></div>)}
                                    </Card>
                                </div>
                            )}

                            {/* FITUR TAMBAHAN */}
                            {view === 'finance' && <FinanceView logs={logs} requests={requests} />}
                            {view === 'restock' && <RestockView inventory={inventory} requests={requests} user={user} />}
                            {view === 'hpp' && <HPPCalculator inventory={inventory} />}

                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<KitchenPro />);
    </script>
</body>
</html>